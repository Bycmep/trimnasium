<!DOCTYPE html>
<html lang="en-US">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="./calendar.css">
<title>Calendar</title>
</head>
<body>

<script type="module">
"use strict";
import { Page } from "../lib/domchain.js";
import { PageParse } from './lib/domchainparse.js';
Page.prototype.parse = PageParse;
import { Day } from "../lib/day.js";
import { Ajax } from "./lib/ajax.js";
import { TimeSelect, NumSelect } from "./lib/timeselect.js";

const urlParams = new URLSearchParams(window.location.search);
const this_day = Day.now();
let current_day = parseInt(urlParams.get('t'));
if (!current_day) current_day = this_day;
const rem = parseFloat(window.getComputedStyle(document.documentElement).fontSize);
const em = parseFloat(window.getComputedStyle(document.body).fontSize);
const days_to_show = Math.ceil((window.innerWidth/em - 4)/27);
const href = window.location.href.split('?')[0];
const forward = `${href}?t=${current_day + days_to_show}`;
const back = `${href}?t=${current_day - days_to_show}`;

const UI = {};
const obj = { start_time: 8.5, end_time: 17.5, occupy: 0.95 };
obj.calendar = Page.body.insert("table.calendar");
const month = [ 'JAN', 'FEB', 'MAR', 'APR', 'MAY',
    'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC' ];
const weekday = [ 'SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT' ];

const header = obj.calendar.insert("tr");
header.parse(`td.side{ div.button#left }`);
for (let day = current_day; day < current_day + days_to_show; day++) {
    const t = Day.toTime(day);
    const red = (t.weekday == 0)? '.red' : '';
    const today = (day == this_day)? '.today' : '';
    header.parse(
        `td.daycell${today}{ table.day{ 
            tr{ td.weekday${red}<$rowspan:2>(${weekday[t.weekday]})#wday td(${month[t.month]}) }
            tr{ td(${t.day + 1}) }
        }}`); 
}
header.parse(`td.side<$rowspan:0>{ div.button#right }`);
Page.$left.$e.onclick = _ => { window.location.href = back };
Page.$right.$e.onclick = _ => { window.location.href = forward };

for (let i = obj.start_time; i <= obj.end_time; i += 0.5) {
    const row = obj.calendar.insert("tr");
    const time = (Math.floor(i) == i)? ((i < 13)? `${i}am` : `${i - 12}pm`) : "";
    row.insert("td.time").text(time);
    for (let j = 0; j < days_to_show; j++) row.insert("td.cell");
}
const screener = Page.body.insert("div.screener");

const api = new Ajax("api.php");

async function initializeEvents() {
    await createEvents();
    await arrangeEvents();
    await placeEvents();
}
initializeEvents();

const all_events = [], ref = [];
for (let i = 0; i < days_to_show; i++) all_events.push([]);
async function createEvents() {
    const events = await api.get({ events: current_day, to: (current_day + days_to_show - 1) });
    for (const e of events) {
        e.day = parseInt(e.day);
        e.start = parseInt(e.time);
        e.duration = parseInt(e.duration);
        e.end = e.start + e.duration;
        ref[e.id] = e;
        all_events[e.day - current_day].push(e);
        const cell = Page.body.insert(`div.event.c${e.category}`).id(`e${e.id}`);
        cell.$e.onclick = _ => { editEvent(e.id); };
        cell.insert("div.desc").text(e.description);
    }
}

async function arrangeEvents() {
    for (let i = 0; i < days_to_show; i++) {
        const events = all_events[i];
        const slots = [];
        events.sort((a, b) => { return (b.duration - a.duration); });

        for (const e of events) {
            let j;
            for (j = 0; j < slots.length; j++) {
                const slot = slots[j];
                let k;
                for (k = 0; k < slot.length; k++) {
                    const e2 = slot[k];
                    if (!((e2.start <= e.start && e2.end <= e.start) ||
                        (e2.start >= e.end && e2.end >= e.end))) break;
                }
                if (k != slot.length) continue;
                e.slot = j; slots[j].push(e); break;
            }
            if (j == slots.length) {
                e.slot = j; slots.push([e]);
            }
        }
        for (const e of events) e.slots = slots.length;
    }
}

async function placeEvents() {
    for (let i = 0; i < days_to_show; i++) {
        const events = all_events[i];
        const cellbox = obj.calendar.child(1).child(i + 1).getBox();

        for (let e of events) {
            Page[`$e${e.id}`].set({
                _left: `${cellbox.left + cellbox.width*(e.slot/e.slots*obj.occupy)}px`,
                _top: `${cellbox.top + (e.start - obj.start_time*60)/30*cellbox.height}px`,
                _width: `${cellbox.width*obj.occupy/e.slots}px`,
                _height: `${cellbox.height*e.duration/30}px` });
        }
    }
}

function editEvent(id) {
    const cell = Page[`$e${id}`].class('openCell').clear();
    screener.class('block');
    const e = ref[id];

    cell.$e.onclick = () => {};
    cell.$e.onanimationend = () => {
        cell.parse(`div.container{ div.r1{ div.button#close } div.r2{ div.editor#editor } div.r1 }`);
        const time = new TimeSelect(e.start, 5);
        const duration = new NumSelect(e.duration, 5, 120, 5, 3);

        Page.$editor.insert("text", "Time: ").append(time.$o).
            append("span", { _display: 'inline-block',_width: '1em' }).
            append("text", "Duration: ").append(duration.$o).append("text", "min");
        Page.$editor.insert("p").text(e.description);

        time.minTime = 8*60 + 30; time.maxTime = 21*60 + 30;

        Page.$close.$e.onclick = async () => {
            if (e.start != time.minutes || e.duration != duration.number) {
                e.start = time.minutes; e.duration = duration.number;
                e.end = e.start + e.duration;
                await arrangeEvents(); await placeEvents();
            }
            cell.clear();
            const style = cell.$e.style;
            const rstyle = document.documentElement.style;
            rstyle.setProperty('--left', style.left);
            rstyle.setProperty('--top', style.top);
            rstyle.setProperty('--width', style.width);
            rstyle.setProperty('--height', style.height);
            cell.declass("openCell").class("closeCell");
            screener.declass("block").class("unblock");
            screener.$e.onanimationend = () => {
                screener.declass("unblock");
            }
            cell.$e.onanimationend = () => {
                cell.declass("closeCell").clear();
            }
        }
    }










    

}

const resizer = new ResizeObserver(placeEvents);
resizer.observe(obj.calendar.$e);


</script>
</body>
</html>